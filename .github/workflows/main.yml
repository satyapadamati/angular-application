name: Deploy Angular App to IIS

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 16

    - name: Install Dependencies
      run: npm install

    - name: Build Angular App
      run: npm run build -- --configuration=production

    - name: Deploy to IIS
      shell: pwsh
      env:
        IIS_SERVER: ${{ secrets.IIS_SERVER }}
        IIS_USER: ${{ secrets.IIS_USER }}
        IIS_PASSWORD: ${{ secrets.IIS_PASSWORD }}
      run: |
        $password = ConvertTo-SecureString "${{ secrets.IIS_PASSWORD }}" -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential("${{ secrets.IIS_USER }}", $password)
        
        # Define source and destination paths
        $sourcePath = "${{ github.workspace }}\dist\my-angular9-app"
        $destinationPath = "C:\inetpub\wwwroot\my-angular9-app"
        
        # Copy files to IIS server
        Invoke-Command -ComputerName "${{ secrets.IIS_SERVER }}" -Credential $credential -ScriptBlock {
            param($source, $destination)
            
            # Create the destination directory if it doesn't exist
            if (-Not (Test-Path -Path $destination)) {
                New-Item -ItemType Directory -Path $destination
            }
            
            # Copy files
            Copy-Item -Path $source\* -Destination $destination -Recurse -Force
        } -ArgumentList $sourcePath, $destinationPath
