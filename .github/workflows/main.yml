name: Deploy Angular App to IIS

on:
  push:
    branches:
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 16

    - name: Install Dependencies
      run: npm ci

    - name: Build Angular App
      run: npm run build -- --configuration=production

    - name: Copy Files to IIS Server using WinRM
      uses: microsoft/psscript-action@v1
      with:
        inlineScript: |
          # Establish WinRM connection
          $destinationPath = "C:\inetpub\wwwroot\my-angular9-app"
          $sourcePath = "./dist/my-angular9-app/*"

          Write-Host "Copying files to IIS server..."
          if (-Not (Test-Path -Path $destinationPath)) {
              New-Item -Path $destinationPath -ItemType Directory -Force
          }

          # Use robocopy for reliable file transfer
          robocopy ${{ github.workspace }}\dist\my-angular9-app $destinationPath /E /MIR

          Write-Host "Files copied successfully!"

    - name: Restart IIS Server
      uses: microsoft/psscript-action@v1
      with:
        inlineScript: |
          Write-Host "Restarting IIS..."
          iisreset
          Write-Host "IIS restarted successfully!"
